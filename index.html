<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASV Song Management System</title>
    <!-- ‚úÖ FAVICON (TITLE LOGO) -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dukooy5f1/image/upload/v1685466452/my_logo_ao2nu4.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* --- ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ CSS ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶¨‡¶ú‡¶æ‡ßü ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá --- */
        :root{--sidebar-width:280px;--primary-color:#11ede6;--secondary-color:#d544ef;--sidebar-bg:#111827;--sidebar-hover:#1f2937;--text-light:#9ca3af;--border-color:#e5e7eb}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter','Segoe UI',sans-serif;overflow-x:hidden}
        .gradient-bg{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%)}
        .stat-card{transition:all .3s ease;border-radius:16px}
        .sidebar{position:fixed;top:0;left:0;height:100vh;width:var(--sidebar-width);background:var(--sidebar-bg);transition:all .3s ease;z-index:1000;overflow-y:auto;box-shadow:2px 0 10px rgba(0,0,0,.1)}
        .sidebar-header{padding:2rem 1.5rem;border-bottom:1px solid #374151;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color))}
        .sidebar-header h5{color:white;font-weight:700;font-size:1.25rem;margin:0}
        .main-content{margin-left:var(--sidebar-width);min-height:100vh;background:#f8fafc;transition:margin-left .3s ease}
        .top-header{background:white;border-bottom:1px solid var(--border-color);padding:1.5rem 2rem;position:sticky;top:0;z-index:999;backdrop-filter:blur(10px)}
        .song-table tbody tr{background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
        #loadingCircle{position:fixed;top:0;left:0;width:100%;height:100%;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s ease}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:16px}
        .card img{width:100%;height:180px;object-fit:cover;border-radius:6px;cursor:pointer}
        /* Player Styles */
        .player-info h4 {font-size:1.5rem; font-weight:700; color:var(--primary-color); overflow: hidden; white-space: nowrap;}
        .marquee-active {animation: marquee 10s linear infinite;}
        @keyframes marquee {0% { transform: translateX(100%); } 100% { transform: translateX(-100%); }}
        #customSeekBar {width: 100%; height: 6px; background: #444; border-radius: 999px; cursor: pointer;}
        .full-player-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1f2937 0%,#000000 100%);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;color:white}
        #miniPlayerBar{position:fixed;bottom:0;left:var(--sidebar-width);right:0;height:70px;background:#1a1a1a;color:white;z-index:1500;display:none;align-items:center;padding:0 15px;cursor: pointer;}
        @media (max-width:768px){#miniPlayerBar{left:0}}
    </style>
</head>

<body>
    <!-- LOADING SCREEN -->
    <div id="loadingCircle">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <span id="overviewLoadingText" class="mt-3 font-bold text-dark">Synchronizing System...</span>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container d-none">
        <div class="login-card">
            <div class="text-center mb-4">
                <h1 class="h3 font-weight-bold text-gray-800">ASV SONG MANAGER</h1>
            </div>
            <form id="loginForm">
                <input type="text" id="username" class="form-control mb-3" placeholder="Username" required>
                <input type="password" id="password" class="form-control mb-4" placeholder="Password" required>
                <button type="submit" class="btn btn-primary w-100">Sign In</button>
            </form>
            <div class="text-center mt-3"><button class="btn btn-link text-danger" onclick="showDashboard(true)">Guest Access</button></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="d-none">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="btn btn-link" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h5 class="mb-0 text-primary">MR SONGS</h5>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div class="mobile-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header"><h5>ASV PROJECT</h5></div>
            <div class="sidebar-nav">
                <a class="nav-link active" onclick="showSection('overview', this)"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                <a class="nav-link" onclick="showPlayerScreen(this)"><i class="fas fa-play-circle me-2"></i>Music Player</a>
                <div id="adminPanel" class="d-none">
                    <hr class="text-white opacity-25">
                    <a class="nav-link" onclick="showSection('add-song', this)"><i class="fas fa-plus-circle me-2"></i>Add Song</a>
                    <a class="nav-link" onclick="showSection('list-songs', this)"><i class="fas fa-list-alt me-2"></i>List Songs</a>
                </div>
                <a class="nav-link bg-primary text-white mt-4" onclick="showLoginScreen(this)">Admin Login</a>
            </div>
        </div>

        <div class="main-content">
            <div class="top-header" id="topHeader">
                <h2 class="h4 mb-0">Welcome, <span id="topHeaderUsername">Guest</span>!</h2>
                <div class="d-flex gap-2"><button class="btn btn-outline-primary btn-sm" onclick="refresh()">Refresh</button><button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button></div>
            </div>

            <div class="content-area">
                <div id="overview" class="section-content">
                    <div class="topbar mb-4"><input id="searchInput" type="text" class="form-control rounded-pill" placeholder="Search title, artist..." oninput="applyFilters()"></div>
                    <div class="categories mb-4 overflow-auto d-flex gap-2" id="categoryList"></div>
                    <div id="bookGrid"></div>
                </div>

                <!-- ADD SONG -->
                <div id="add-song" class="section-content d-none">
                    <div class="dashboard-card p-4">
                        <h5>Add New Song</h5>
                        <form id="songForm" class="row g-3">
                            <div class="col-md-6"><input type="text" id="serialNo" class="form-control" placeholder="Serial"></div>
                            <div class="col-md-6"><input type="text" id="title" class="form-control" placeholder="Title" required></div>
                            <div class="col-md-6"><input type="text" id="author" class="form-control" placeholder="Artist" required></div>
                            <div class="col-md-6"><input type="text" id="category" class="form-control" placeholder="Category" required></div>
                            <div class="col-md-6"><input type="url" id="imageUrl" class="form-control" placeholder="Image URL"></div>
                            <div class="col-md-6"><input type="url" id="songUrl" class="form-control" placeholder="Song URL" required></div>
                            <div class="col-12"><textarea id="description" class="form-control" placeholder="Description"></textarea></div>
                            <button type="submit" class="btn btn-primary">Save Song</button>
                        </form>
                    </div>
                </div>

                <!-- LIST SONGS -->
                <div id="list-songs" class="section-content d-none">
                    <div class="dashboard-card p-4 table-responsive">
                        <table class="table"><thead class="table-dark"><tr><th>#</th><th>Title</th><th>Artist</th><th>Actions</th></tr></thead><tbody id="songsTableBody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL PLAYER -->
    <div class="full-player-screen" id="fullPlayerScreen">
        <div class="player-header p-4"><button class="btn btn-light btn-sm" onclick="closePlayer()">Back</button></div>
        <div class="album-art-box"><img id="playerArt" src="" class="album-art"></div>
        <div class="player-info text-center mt-4"><h4 id="playerTitle">Select Song</h4><p id="playerArtist">Artist</p></div>
        <div class="px-5 w-100 d-flex align-items-center gap-3">
            <span id="currentTimeDisplay">0:00</span>
            <input type="range" id="customSeekBar" value="0">
            <span id="durationDisplay">0:00</span>
        </div>
        <div class="player-controls mt-4 d-flex align-items-center gap-5">
            <button class="control-btn" onclick="playPrev()"><i class="fas fa-backward fa-2x"></i></button>
            <button class="control-btn main" id="playPauseBtn" onclick="togglePlayPause()"><i class="fas fa-play-circle fa-5x"></i></button>
            <button class="control-btn" onclick="playNext()"><i class="fas fa-forward fa-2x"></i></button>
        </div>
        <audio id="audioElement"></audio>
    </div>

    <!-- MINI PLAYER -->
    <div id="miniPlayerBar" onclick="showPlayerScreen()">
        <div id="miniPlayerArt" class="me-3" style="width:45px; height:45px; border-radius:5px; background:#333; overflow:hidden"></div>
        <div class="flex-grow-1"><div id="miniPlayerTitle" class="fw-bold text-truncate" style="max-width:200px">Title</div><div id="miniPlayerArtist" class="small opacity-50">Artist</div></div>
        <div class="d-flex gap-3">
            <button class="btn btn-link text-white p-0" onclick="event.stopPropagation(); playPrev()"><i class="fas fa-backward"></i></button>
            <button class="btn btn-link text-white p-0" onclick="event.stopPropagation(); togglePlayPause()"><i class="fas fa-play" id="miniPlayIcon"></i></button>
            <button class="btn btn-link text-white p-0" onclick="event.stopPropagation(); playNext()"><i class="fas fa-forward"></i></button>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal fade" id="editSongModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"><form id="editSongForm"><div class="modal-body">
                <input type="hidden" id="editRowId">
                <input type="text" id="editSerialNo" class="form-control mb-2" placeholder="Serial">
                <input type="text" id="editTitle" class="form-control mb-2" placeholder="Title" required>
                <input type="text" id="editAuthor" class="form-control mb-2" placeholder="Artist" required>
                <input type="text" id="editCategory" class="form-control mb-2" placeholder="Category" required>
                <input type="url" id="editImageUrl" class="form-control mb-2" placeholder="Image URL">
                <input type="url" id="editSongUrl" class="form-control mb-2" placeholder="Song URL" required>
                <textarea id="editDescription" class="form-control" placeholder="Description"></textarea>
            </div><div class="modal-footer"><button type="submit" class="btn btn-primary">Save Changes</button></div></form></div>
        </div>
    </div>

    <script>
        // --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ì ‡¶ü‡ßã‡¶ï‡ßá‡¶® ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGYi8h5VBxy41qxJDcPNBqERci5dm8haHlwYwISt_ewPXK0QdUIAj7notIXwjsyPJwXg/exec";
        const SECRET_TOKEN = "ASV_SONG_MANAGER_PRO_2024";

        // ‡¶Æ‡ßá‡¶á‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (google.script.run ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá)
        async function runGAS(action, payload = {}) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ token: SECRET_TOKEN, action, payload })
                });
                return await response.json();
            } catch (err) {
                return { success: false, message: "Network error" };
            }
        }

        // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π ---
        let allBooks = [];
        let currentPlaylist = [];
        let currentSongIndex = -1;
        let isUserLoggedIn = false;
        let isAdmin = false;
        let currentUser = 'Guest';
        const AUTH_KEY = 'asv_song_auth_v1';
        const audio = document.getElementById('audioElement');
        const customSeekBar = document.getElementById('customSeekBar');
        let isSeeking = false;
        const DEFAULT_IMG = 'https://res.cloudinary.com/dukooy5f1/image/upload/v1676877360/IMG_20230209_060336_335_zdwejn.jpg';

        // --- ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            refresh();
            
            // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤
            audio.addEventListener('play', () => updateMiniUI(true));
            audio.addEventListener('pause', () => updateMiniUI(false));
            audio.addEventListener('ended', () => playNext());
            audio.addEventListener('timeupdate', () => {
                if(!isSeeking && !isNaN(audio.duration)) {
                    customSeekBar.value = audio.currentTime;
                    updateSeekBarUI(audio.currentTime, audio.duration);
                    document.getElementById('currentTimeDisplay').textContent = formatTime(audio.currentTime);
                    saveState();
                }
            });
            audio.addEventListener('loadedmetadata', () => {
                customSeekBar.max = audio.duration;
                document.getElementById('durationDisplay').textContent = formatTime(audio.duration);
            });
            customSeekBar.addEventListener('input', () => { isSeeking = true; });
            customSeekBar.addEventListener('change', () => { isSeeking = false; audio.currentTime = customSeekBar.value; });

            // ‡¶∏‡ßã‡ßü‡¶æ‡¶á‡¶™ ‡¶ú‡ßá‡¶∏‡¶ö‡¶æ‡¶∞
            let startX;
            document.getElementById('fullPlayerScreen').addEventListener('touchstart', e => startX = e.touches[0].clientX);
            document.getElementById('fullPlayerScreen').addEventListener('touchend', e => {
                const diff = e.changedTouches[0].clientX - startX;
                if(Math.abs(diff) > 50) diff > 0 ? playPrev() : playNext();
            });
        });

        async function refresh() {
            showLoader(true);
            const data = await runGAS('getBooks');
            allBooks = data || [];
            currentPlaylist = allBooks.filter(b => b.Song_URL && b.Song_URL.startsWith('http'));
            renderCategories();
            filterBy('all');
            restoreState();
            showLoader(false);
        }

        function renderCategories() {
            const cats = [...new Set(allBooks.map(b => b.Category).filter(Boolean))];
            const list = document.getElementById('categoryList');
            list.innerHTML = `<button onclick="filterBy('all', this)" class="btn btn-sm btn-outline-primary active">All</button>` +
                cats.map(c => `<button onclick="filterBy('${c}', this)" class="btn btn-sm btn-outline-primary">${c}</button>`).join('');
        }

        function filterBy(cat, el) {
            if(el) {
                document.querySelectorAll('#categoryList button').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allBooks.filter(b => {
                const matchTerm = (b.Title + b.Author + b.Category).toLowerCase().includes(term);
                return cat === 'all' ? matchTerm : (matchTerm && b.Category === cat);
            });
            renderGrid(filtered);
        }

        function applyFilters() { filterBy('all'); }

        function renderGrid(data) {
            const grid = document.getElementById('bookGrid');
            grid.className = 'grid';
            grid.innerHTML = data.map(b => `
                <div class="card">
                    <img src="${b.Image_URL || DEFAULT_IMG}" onclick="playSong('${b.rowId}')">
                    <h3 class="mt-2 text-truncate w-100">${b.Title}</h3>
                    <p class="small opacity-75">${b.Author}</p>
                    <div class="d-flex gap-3 mt-2">
                        <span onclick="handleReaction('fav', ${b.rowId})" class="cursor-pointer">${b.Favorite === 'Y' ? 'üíú' : 'ü§ç'}</span>
                        <span onclick="handleReaction('like', ${b.rowId})" class="cursor-pointer">üëç ${b.Like || 0}</span>
                    </div>
                </div>
            `).join('') || '<p class="text-white text-center w-100">No songs found.</p>';
        }

        function playSong(rowId) {
            const idx = currentPlaylist.findIndex(b => b.rowId == rowId);
            if(idx !== -1) {
                currentSongIndex = idx;
                const song = currentPlaylist[idx];
                audio.src = song.Song_URL;
                audio.play();
                updateFullUI(song);
                document.getElementById('fullPlayerScreen').style.display = 'flex';
            }
        }

        function togglePlayPause() { audio.paused ? audio.play() : audio.pause(); }
        function playNext() { if(currentPlaylist.length) playSong(currentPlaylist[(currentSongIndex + 1) % currentPlaylist.length].rowId); }
        function playPrev() { if(currentPlaylist.length) playSong(currentPlaylist[(currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length].rowId); }

        function updateFullUI(song) {
            const titleEl = document.getElementById('playerTitle');
            titleEl.textContent = song.Title;
            titleEl.classList.toggle('marquee-active', song.Title.length > 30);
            document.getElementById('playerArtist').textContent = song.Author;
            document.getElementById('playerArt').src = song.Image_URL || DEFAULT_IMG;
            updateMiniUI(!audio.paused);
        }

        function updateMiniUI(playing) {
            if(currentSongIndex === -1) return;
            const song = currentPlaylist[currentSongIndex];
            document.getElementById('miniPlayerBar').style.display = 'flex';
            document.getElementById('miniPlayerTitle').textContent = song.Title;
            document.getElementById('miniPlayerArtist').textContent = song.Author;
            document.getElementById('miniPlayIcon').className = playing ? 'fas fa-pause' : 'fas fa-play';
            document.getElementById('miniPlayerArt').innerHTML = `<img src="${song.Image_URL || DEFAULT_IMG}" width="100%">`;
            document.getElementById('playPauseBtn').innerHTML = `<i class="fas ${playing ? 'fa-pause-circle' : 'fa-play-circle'} fa-5x"></i>`;
        }

        async function handleReaction(type, rowId) {
            if(rowId >= 10000) return Swal.fire('Error', 'Drive reaction not allowed', 'info');
            if(!isUserLoggedIn) return Swal.fire('Error', 'Login Required', 'warning');
            await runGAS('updateFeedback', { rowId, type });
            refresh();
        }

        // --- AUTH & SECTIONS ---
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await runGAS('authenticateUser', { username: document.getElementById('username').value, password: document.getElementById('password').value });
            if(res.success) { localStorage.setItem(AUTH_KEY, JSON.stringify(res)); location.reload(); }
            else Swal.fire('Error', res.message, 'error');
        };

        function checkAuth() {
            const saved = localStorage.getItem(AUTH_KEY);
            if(saved) {
                const data = JSON.parse(saved);
                isUserLoggedIn = true;
                isAdmin = data.role === 'ALL';
                document.getElementById('topHeaderUsername').textContent = data.username;
                document.getElementById('loginScreen').classList.add('d-none');
                document.getElementById('dashboard').classList.remove('d-none');
                document.getElementById('adminPanel').classList.toggle('d-none', !isAdmin);
            } else {
                document.getElementById('loginScreen').classList.remove('d-none');
            }
        }

        function logout() { localStorage.removeItem(AUTH_KEY); location.reload(); }
        function showSection(id, el) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('d-none'));
            document.getElementById(id).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'list-songs') fetchSongs();
        }

        async function fetchSongs() {
            const res = await runGAS('getSongsList');
            document.getElementById('songsTableBody').innerHTML = res.songs.map(s => `
                <tr><td>${s.serialNo}</td><td>${s.title}</td><td>${s.author}</td>
                <td><button onclick="editSong(${s.rowId})" class="btn btn-sm btn-info">Edit</button>
                <button onclick="deleteSong(${s.rowId})" class="btn btn-sm btn-danger">Delete</button></td></tr>`).join('');
        }

        async function editSong(rowId) {
            const res = await runGAS('getSongById', {rowId});
            if(res.success) {
                const s = res.song;
                document.getElementById('editRowId').value = s.rowId;
                document.getElementById('editTitle').value = s.title;
                document.getElementById('editAuthor').value = s.author;
                document.getElementById('editCategory').value = s.category;
                document.getElementById('editSongUrl').value = s.songUrl;
                new bootstrap.Modal(document.getElementById('editSongModal')).show();
            }
        }

        document.getElementById('songForm').onsubmit = async (e) => {
            e.preventDefault();
            const songData = { serialNo: document.getElementById('serialNo').value, title: document.getElementById('title').value, author: document.getElementById('author').value, category: document.getElementById('category').value, songUrl: document.getElementById('songUrl').value, imageUrl: document.getElementById('imageUrl').value };
            await runGAS('addSong', { songData });
            Swal.fire('Success', 'Song added', 'success');
            refresh();
        };

        function showLoader(s) { document.getElementById('loadingCircle').classList.toggle('d-none', !s); }
        function formatTime(s) { const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        function updateSeekBarUI(c, d) { const p = (c/d)*100; customSeekBar.style.background = `linear-gradient(to right, #48b8e0 ${p}%, #444 ${p}%)`; }
        function closePlayer() { document.getElementById('fullPlayerScreen').style.display = 'none'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.querySelector('.mobile-overlay').classList.toggle('show'); }
        function showPlayerScreen() { document.getElementById('fullPlayerScreen').style.display = 'flex'; }
        function saveState() { localStorage.setItem('lastIdx', currentSongIndex); localStorage.setItem('lastPos', audio.currentTime); }
        function restoreState() {
            const idx = localStorage.getItem('lastIdx');
            if(idx !== null && currentPlaylist[idx]) {
                currentSongIndex = parseInt(idx);
                const song = currentPlaylist[currentSongIndex];
                audio.src = song.Song_URL;
                audio.currentTime = parseFloat(localStorage.getItem('lastPos') || 0);
                updateFullUI(song);
            }
        }
    </script>
</body>
</html>
