<script>
    /* 
    ============================================================
    üöÄ ASV SONG MANAGER - FULL GITHUB COMPATIBLE SCRIPT
    ============================================================
    */

    // --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ) ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGYi8h5VBxy41qxJDcPNBqERci5dm8haHlwYwISt_ewPXK0QdUIAj7notIXwjsyPJwXg/exec";
    const SECRET_TOKEN = "ASV_SONG_MANAGER_PRO_2024"; 

    /**
     * ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶Æ‡ßá‡¶á‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡•§
     * ‡¶è‡¶ü‡¶ø google.script.run ‡¶è‡¶∞ ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡•§
     */
    async function runGAS(action, payload = {}) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    token: SECRET_TOKEN, 
                    action: action, 
                    payload: payload 
                })
            });
            return await response.json();
        } catch (err) {
            console.error("Connection Error:", err);
            return { success: false, message: "Network Error: Please check internet." };
        }
    }

    // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π (‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ) ---
    let currentUser = 'Guest';
    let currentUserRole = 'GUEST';
    let isAdmin = false;
    let isUserLoggedIn = false;
    const AUTH_STORAGE_KEY = 'asv_auth_data_songs';
    const LOGIN_EXPIRY_DAYS = 30;
    
    let allBooks = []; 
    let currentFilter = 'all';
    let currentCategory = '';
    let allSongs = []; 
    
    // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤‡¶∏
    const audio = document.getElementById('audioElement');
    const fullPlayerScreen = document.getElementById('fullPlayerScreen');
    const playerTitle = document.getElementById('playerTitle');
    const playerTitleText = document.getElementById('playerTitleText'); 
    const playerArtist = document.getElementById('playerArtist');
    const playerArt = document.getElementById('playerArt');
    const playPauseBtn = document.getElementById('playPauseBtn');
    
    let currentSongIndex = -1; 
    let currentPlaylist = []; 
    const DEFAULT_COVER_URL = 'https://res.cloudinary.com/dukooy5f1/image/upload/v1676877360/IMG_20230209_060336_335_zdwejn.jpg'; 

    // ‡¶Æ‡¶ø‡¶®‡¶ø ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶ì ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶∞ ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü
    const miniPlayerBar = document.getElementById('miniPlayerBar');
    const miniPlayerTitle = document.getElementById('miniPlayerTitle');
    const miniPlayerArtist = document.getElementById('miniPlayerArtist');
    const miniPlayerArtDiv = document.getElementById('miniPlayerArt');
    const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
    
    const customSeekBar = document.getElementById('customSeekBar');
    const currentTimeDisplay = document.getElementById('currentTimeDisplay');
    const durationDisplay = document.getElementById('durationDisplay');
    let isSeeking = false;

    // DOM ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
    const loadingCircle = document.getElementById('loadingCircle');
    const categoryList = document.getElementById('categoryList');
    const bookGrid = document.getElementById('bookGrid');
    const searchInput = document.getElementById('searchInput');

    // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶ì ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ---
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentDate();
        setInterval(updateCurrentDate, 60000);
        checkSavedLogin();
        showDashboard(false);
        showAndHideCircle(true);
        
        // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
        document.getElementById('songForm')?.addEventListener('submit', handleSongFormSubmit);
        document.getElementById('editSongForm')?.addEventListener('submit', handleEditFormSubmit);
        
        // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        audio.addEventListener('play', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause-circle"></i>';
            updateMiniPlayerUI(true);
        });
        audio.addEventListener('pause', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play-circle"></i>';
            updateMiniPlayerUI(false);
        });
        audio.addEventListener('ended', () => playNext());
        
        // ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        audio.addEventListener('loadedmetadata', () => {
            customSeekBar.max = audio.duration;
            durationDisplay.textContent = formatTime(audio.duration);
        });

        audio.addEventListener('timeupdate', () => {
            if (!isSeeking && !isNaN(audio.duration)) { 
                customSeekBar.value = audio.currentTime;
                updateSeekBarUI(audio.currentTime, audio.duration);
            }
            currentTimeDisplay.textContent = formatTime(audio.currentTime);
            savePlaybackPosition();
        });

        customSeekBar.addEventListener('input', () => {
            isSeeking = true;
            currentTimeDisplay.textContent = formatTime(customSeekBar.value);
            updateSeekBarUI(customSeekBar.value, customSeekBar.max);
        });

        customSeekBar.addEventListener('change', () => {
            isSeeking = false;
            audio.currentTime = customSeekBar.value;
        });

        // ‡¶∏‡ßã‡ßü‡¶æ‡¶á‡¶™ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶≤‡ßã‡¶°
        addSwipeGestureToPlayer();
        refresh(); 
    });

    // --- ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π ---

    async function refresh() {
        showAndHideCircle(true, "Synchronizing Library...");
        const data = await runGAS('getBooks');
        allBooks = data || [];
        currentPlaylist = allBooks.filter(book => book.Song_URL && book.Song_URL.startsWith('http'));
        
        renderCategories();
        filterBy('all', document.querySelector('.categories button[onclick*="all"]')); 
        restorePlaybackState();
        showAndHideCircle(false);
    }

    async function handleLoginSubmit(e) {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        Swal.fire({title: 'Authenticating...', didOpen: () => Swal.showLoading()});
        
        const res = await runGAS('authenticateUser', {username: u, password: p});
        Swal.close();
        if (res.success) {
            applyLoginData(res);
            saveLoginData(res);
            Swal.fire({title: 'Welcome!', icon: 'success', timer: 1500, showConfirmButton: false});
            showDashboard();
            refresh();
        } else {
            Swal.fire('Error', res.message, 'error');
        }
    }
    document.getElementById('loginForm').onsubmit = handleLoginSubmit;

    async function handleReaction(type, rowId) {
        if (rowId >= 10000) { 
            Swal.fire({toast: true, position: 'top-end', title: 'Drive song: Reactions not saved', icon: 'info', timer: 2000, showConfirmButton: false});
            return; 
        }
        if (!isUserLoggedIn) { Swal.fire('Login Required', 'Please sign in.', 'warning'); return; }
        
        const res = await runGAS('updateFeedback', {rowId, type});
        if(res.success) refresh();
    }

    async function handleSongFormSubmit(e) {
        e.preventDefault();
        const songData = {
            serialNo: document.getElementById('serialNo').value,
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            category: document.getElementById('category').value,
            imageUrl: document.getElementById('imageUrl').value,
            songUrl: document.getElementById('songUrl').value,
            description: document.getElementById('description').value
        };
        Swal.showLoading();
        const res = await runGAS('addSong', {songData});
        Swal.fire('Success', res.message, 'success');
        document.getElementById('songForm').reset();
        refresh();
    }

    async function fetchSongs() {
        const tableBody = document.getElementById('songsTableBody');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>`;
        const res = await runGAS('getSongsList');
        if(res.success) { 
            allSongs = res.songs; 
            displaySongs(allSongs); 
        }
    }

    async function editSong(rowId) {
        if (rowId >= 10000) { Swal.fire('Note', 'Drive songs cannot be edited here.', 'info'); return; }
        Swal.showLoading();
        const res = await runGAS('getSongById', {rowId});
        Swal.close();
        if(res.success) loadEditForm(res);
    }

    async function handleEditFormSubmit(e) {
        e.preventDefault();
        const songData = {
            rowId: document.getElementById('editRowId').value,
            Serial_Number: document.getElementById('editSerialNo').value,
            Title: document.getElementById('editTitle').value,
            Author: document.getElementById('editAuthor').value,
            Category: document.getElementById('editCategory').value,
            Image_URL: document.getElementById('editImageUrl').value,
            Song_URL: document.getElementById('editSongUrl').value,
            Description: document.getElementById('editDescription').value
        };
        Swal.showLoading();
        const res = await runGAS('updateSong', {songData});
        if(res.success) {
            Swal.fire('Updated!', res.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editSongModal')).hide();
            fetchSongs(); refresh();
        }
    }

    async function deleteSong(rowId, title) {
        if (rowId >= 10000) { Swal.fire('Note', 'Drive songs cannot be deleted here.', 'info'); return; }
        const confirm = await Swal.fire({title: 'Delete Song?', text: title, icon: 'warning', showCancelButton: true});
        if(confirm.isConfirmed) {
            Swal.showLoading();
            const res = await runGAS('deleteSong', {rowId, username: currentUser});
            if(res.success) { Swal.fire('Deleted!', '', 'success'); fetchSongs(); refresh(); }
        }
    }

    // --- ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï) ---

    function loadAndPlaySong(index) {
        if (index >= 0 && index < currentPlaylist.length) {
            currentSongIndex = index;
            const song = currentPlaylist[index];
            updateFullPlayerUI(song);
            audio.src = song.Song_URL;
            audio.load();
            audio.play().catch(e => console.log("User Interaction Required"));
            fullPlayerScreen.style.display = 'flex';
            updateMiniPlayerUI(true);
        }
    }

    function togglePlayPause() {
        if (audio.paused) audio.play(); else audio.pause();
    }

    function playNext() {
        if (currentPlaylist.length === 0) return;
        loadAndPlaySong((currentSongIndex + 1) % currentPlaylist.length);
    }

    function playPrev() {
        if (currentPlaylist.length === 0) return;
        loadAndPlaySong((currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length);
    }

    function updateFullPlayerUI(song) {
        playerTitleText.textContent = song.Title || 'Untitled';
        playerArtist.textContent = song.Author || 'Unknown Artist';
        playerArt.src = (song.Image_URL && song.Image_URL.startsWith('http')) ? song.Image_URL : DEFAULT_COVER_URL;
        
        // Marquee Effect: 40 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶≤‡ßá ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶ü‡¶ó‡¶≤ ‡¶π‡¶¨‡ßá
        playerTitle.classList.remove('marquee-active');
        if (playerTitleText.textContent.length > 40) {
            playerTitle.classList.add('marquee-active');
        }
        
        currentTimeDisplay.textContent = '0:00';
        durationDisplay.textContent = '0:00';
        customSeekBar.value = 0;
        updateSeekBarUI(0, 100);
    }

    function updateMiniPlayerUI(isPlaying) {
        if (currentSongIndex !== -1 && currentPlaylist[currentSongIndex]) {
            const song = currentPlaylist[currentSongIndex];
            const titleText = song.Title || 'Untitled';
            miniPlayerTitle.textContent = titleText.length > 30 ? titleText.substring(0, 27) + '...' : titleText;
            miniPlayerArtist.textContent = song.Author;
            miniPlayPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            miniPlayerBar.classList.add('show');
            
            // ‡¶Æ‡¶ø‡¶®‡¶ø ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            miniPlayerArtDiv.innerHTML = '';
            const img = document.createElement('img');
            img.src = (song.Image_URL && song.Image_URL.startsWith('http')) ? song.Image_URL : DEFAULT_COVER_URL;
            img.className = 'mini-player-art';
            img.style.width = '100%'; img.style.height = '100%';
            miniPlayerArtDiv.appendChild(img);
        }
    }

    // --- ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶≤‡ßá‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï Persistence ---

    function formatTime(s) {
        if (isNaN(s)) return '0:00';
        const m = Math.floor(s/60); const sc = Math.floor(s%60);
        return `${m}:${sc < 10 ? '0' : ''}${sc}`;
    }

    function updateSeekBarUI(c, d) {
        const p = (c / d) * 100;
        // ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡ßá‡¶°‡¶ø‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
        customSeekBar.style.background = `linear-gradient(to right, #48b8e0 0%, #48b8e0 ${p}%, #444 ${p}%, #444 100%)`;
    }

    function addSwipeGestureToPlayer() {
        let startX;
        fullPlayerScreen.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        fullPlayerScreen.addEventListener('touchend', e => {
            const diffX = e.changedTouches[0].clientX - startX;
            if(Math.abs(diffX) > 50) diffX > 0 ? playPrev() : playNext();
        });
    }

    function savePlaybackPosition() {
        if (!audio.paused && currentSongIndex !== -1) {
            localStorage.setItem('lastIdx', currentSongIndex);
            localStorage.setItem('lastPos', audio.currentTime);
        }
    }

    function restorePlaybackState() {
        const idx = localStorage.getItem('lastIdx');
        const pos = localStorage.getItem('lastPos');
        if(idx !== null && currentPlaylist[idx]) {
            currentSongIndex = parseInt(idx);
            const song = currentPlaylist[currentSongIndex];
            updateFullPlayerUI(song);
            audio.src = song.Song_URL;
            audio.currentTime = parseFloat(pos || 0);
            updateMiniPlayerUI(false);
        }
    }

    // --- ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶ø‡¶â ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) ---

    function updateCurrentDate() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        if(document.getElementById('currentDate')) {
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }
    }

    function checkSavedLogin() {
        const saved = localStorage.getItem(AUTH_STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            if (new Date() < new Date(data.expiry)) { applyLoginData(data); return; }
        }
        applyGuestData();
    }

    function applyLoginData(data) {
        currentUser = data.username; currentUserRole = data.role;
        isAdmin = (data.role === 'ALL'); isUserLoggedIn = true;
        document.getElementById('currentUsername').textContent = currentUser;
        document.getElementById('topHeaderUsername').textContent = currentUser;
        updateUIForUserRole();
    }

    function applyGuestData() {
        currentUser = 'Guest'; currentUserRole = 'GUEST';
        isAdmin = false; isUserLoggedIn = false;
        updateUIForUserRole();
    }

    function updateUIForUserRole() {
        document.querySelectorAll('.logged-in-only').forEach(el => el.style.display = isUserLoggedIn ? '' : 'none');
        document.getElementById('addSongsNav')?.classList.toggle('d-none', !isAdmin);
        document.getElementById('listSongsNav')?.classList.toggle('d-none', !isAdmin);
        document.getElementById('loginButtonText').textContent = isUserLoggedIn ? 'Logout' : 'Admin Login';
    }

    function showDashboard(force) {
        document.getElementById('loginScreen').classList.add('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        updateUIForUserRole();
        if(force) showSection('overview', document.querySelector('.nav-link[onclick*="overview"]'));
    }

    function showSection(name, el) {
        document.querySelectorAll('.section-content').forEach(s => s.classList.add('d-none'));
        document.getElementById(name).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(el) el.classList.add('active');
        if(window.innerWidth < 768) toggleSidebar();
        if(name === 'list-songs') fetchSongs();
        fullPlayerScreen.style.display = 'none';
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.querySelector('.mobile-overlay').classList.toggle('show');
    }

    function renderCategories() {
        const categories = {};
        allBooks.forEach(b => { if(b.Category) categories[b.Category] = (categories[b.Category] || 0) + 1; });
        categoryList.innerHTML = '';
        Object.keys(categories).sort().forEach(cat => {
            const btn = document.createElement('button');
            btn.textContent = `${cat} (${categories[cat]})`;
            btn.onclick = (e) => {
                currentFilter = 'category'; currentCategory = cat;
                document.querySelectorAll('.categories button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                applyFilters();
            };
            categoryList.appendChild(btn);
        });
    }

    function filterBy(type, el) {
        currentFilter = type; currentCategory = '';
        document.querySelectorAll('.categories button').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const term = searchInput.value.toLowerCase();
        let filtered = allBooks.filter(b => {
            const match = `${b.Title} ${b.Author} ${b.Category}`.toLowerCase().includes(term);
            if(currentFilter === 'fav') return match && b.Favorite === 'Y';
            if(currentFilter === 'category') return match && b.Category === currentCategory;
            return match;
        });
        
        currentPlaylist = filtered.filter(b => b.Song_URL && b.Song_URL.startsWith('http'));
        
        // ‡¶≠‡¶ø‡¶â ‡¶Æ‡ßã‡¶° ‡¶≤‡¶ú‡¶ø‡¶ï: All/Fav ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø List View, ‡¶¨‡¶æ‡¶ï‡¶ø‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø Grid View
        const isListView = currentFilter === 'all' || currentFilter === 'fav';
        bookGrid.className = isListView ? 'song-list-container' : 'grid';
        bookGrid.innerHTML = '';

        if (!filtered.length) { bookGrid.innerHTML = '<p class="text-center w-100 p-5">No songs found.</p>'; return; }

        filtered.forEach((b, index) => {
            if (isListView) {
                const item = document.createElement('div');
                item.className = 'song-list-item';
                item.onclick = () => loadAndPlaySong(currentPlaylist.indexOf(b));
                item.innerHTML = `
                    <div class="serial">${index + 1}</div>
                    <div class="icon"><i class="fas fa-music"></i></div>
                    <div class="title-info"><h4>${b.Title}</h4><p>${b.Author}</p></div>
                    <div class="actions" onclick="event.stopPropagation()">
                        <div class="reaction fav-reaction" onclick="handleReaction('fav', ${b.rowId})">
                            <span class="emoji">${b.Favorite === 'Y' ? 'üíú' : 'ü§ç'}</span>
                        </div>
                    </div>`;
                bookGrid.appendChild(item);
            } else {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${b.Image_URL && b.Image_URL.startsWith('http') ? b.Image_URL : DEFAULT_COVER_URL}" onclick="loadAndPlaySong(${currentPlaylist.indexOf(b)})" class="playable">
                    <h3>${b.Title}</h3>
                    <div class="author">${b.Author}</div>
                    <div class="actions">
                        <div class="reaction fav-reaction" onclick="handleReaction('fav', ${b.rowId})">
                            <span class="emoji">${b.Favorite === 'Y' ? 'üíú' : 'ü§ç'}</span>
                        </div>
                        <div class="reaction" onclick="handleReaction('like', ${b.rowId})">
                            <span class="emoji">üëç</span><span class="count">${b.Like || 0}</span>
                        </div>
                    </div>`;
                bookGrid.appendChild(card);
            }
        });
    }

    function showPlayerScreen(el) {
        fullPlayerScreen.style.display = 'flex';
        miniPlayerBar.classList.remove('show');
        if(currentSongIndex === -1 && currentPlaylist.length > 0) loadAndPlaySong(0);
        if(window.innerWidth < 768) toggleSidebar();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    function closePlayer() {
        fullPlayerScreen.style.display = 'none';
        updateMiniPlayerUI(!audio.paused);
        showSection('overview', document.querySelector('.nav-link[onclick*="overview"]'));
    }

    function logout() {
        Swal.fire({title: 'Logout?', icon: 'warning', showCancelButton: true}).then(r => {
            if(r.isConfirmed) {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                localStorage.removeItem('lastIdx');
                localStorage.removeItem('lastPos');
                location.reload();
            }
        });
    }

    function showAndHideCircle(s, t) {
        loadingCircle.classList.toggle('hidden', !s);
        if(s && t) document.getElementById('overviewLoadingText').textContent = t;
    }

    function saveLoginData(data) {
        const expiry = new Date(); expiry.setDate(expiry.getDate() + LOGIN_EXPIRY_DAYS);
        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({...data, expiry: expiry.toISOString()}));
    }

    function loadEditForm(res) {
        const s = res.song;
        document.getElementById('editRowId').value = s.rowId;
        document.getElementById('editSerialNo').value = s.serialNo;
        document.getElementById('editTitle').value = s.title;
        document.getElementById('editAuthor').value = s.author;
        document.getElementById('editCategory').value = s.category;
        document.getElementById('editImageUrl').value = s.imageUrl;
        document.getElementById('editSongUrl').value = s.songUrl;
        document.getElementById('editDescription').value = s.description;
        new bootstrap.Modal(document.getElementById('editSongModal')).show();
    }

    function showLoginScreen(el) {
        if(isUserLoggedIn) { logout(); return; }
        document.getElementById('dashboard').classList.add('d-none');
        document.getElementById('loginScreen').classList.remove('d-none');
    }

    function displaySongs(songsToDisplay) {
        const tableBody = document.getElementById('songsTableBody');
        tableBody.innerHTML = '';
        songsToDisplay.forEach(song => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${song.serialNo || ''}</td>
                <td>${song.title}</td>
                <td>${song.author}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="editSong(${song.rowId})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSong(${song.rowId}, '${song.title.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                </td>`;
        });
    }
</script>
