<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASV Song Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
/* --- (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ CSS) --- */
:root{--sidebar-width:280px;--primary-color:#11ede6;--secondary-color:#d544ef;--sidebar-bg:#111827;--sidebar-hover:#1f2937;--text-light:#9ca3af;--border-color:#e5e7eb}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Segoe UI',sans-serif;overflow-x:hidden}
.gradient-bg{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%)}
.stat-card{transition:all .3s ease;border-radius:16px}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
/* Sidebar Styles */
.sidebar{position:fixed;top:0;left:0;height:100vh;width:var(--sidebar-width);background:var(--sidebar-bg);transition:all .3s ease;z-index:1000;overflow-y:auto;box-shadow:2px 0 10px rgba(0,0,0,.1)}
.sidebar-header{padding:2rem 1.5rem;border-bottom:1px solid #374151;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color))}
.sidebar-header h5{color:white;font-weight:700;font-size:1.25rem;margin:0}
.sidebar-nav{padding:1.5rem 0}
.nav-item{margin:.25rem 1rem}
.nav-link{display:flex;align-items:center;padding:.875rem 1rem;color:#cbd5e1;text-decoration:none;border-radius:12px;font-weight:500;transition:all .3s ease;position:relative}
.nav-link:hover{background:var(--sidebar-hover);color:white;transform:translateX(4px)}
.nav-link.active{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:white;box-shadow:0 4px 12px rgba(102,126,234,.4)}
.nav-link.active::before{content:'';position:absolute;left:-1rem;top:50%;transform:translateY(-50%);width:4px;height:24px;background:white;border-radius:2px}
.nav-link i{width:20px;margin-right:12px;font-size:1.1rem}
.sidebar-footer{position:absolute;bottom:0;left:0;right:0;padding:1.5rem;border-top:1px solid #374151}
/* Main Content */
.main-content{margin-left:var(--sidebar-width);min-height:100vh;background:#f8fafc;transition:margin-left .3s ease}
/* top-header: Default visibility is controlled by JS/CSS */
.top-header{background:white;border-bottom:1px solid var(--border-color);padding:1.5rem 2rem;position:sticky;top:0;z-index:999;backdrop-filter:blur(10px)}
.content-area{padding:2rem}
/* Mobile Styles */
.mobile-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999;display:none;opacity:0;transition:opacity .3s ease}
.mobile-overlay.show{display:block;opacity:1}
.mobile-header{display:none;background:white;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:1000}
@media (max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.show{transform:translateX(0)}.main-content{margin-left:0}.mobile-header{display:flex;justify-content:space-between;align-items:center}.top-header{display:none}
/* Mobile header handles it */
.content-area{padding:1rem}}
/* Custom Form Styles */
.form-control:focus{border-color:var(--primary-color);box-shadow:0 0 0 .2rem rgba(102,126,234,.25)}
.btn-primary{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);border:none;font-weight:600;padding:.75rem 1.5rem;border-radius:12px;transition:all .3s ease}
.btn-primary:hover{background:linear-gradient(135deg,#5a6fd8 0%,#6a4190 100%);transform:translateY(-2px);box-shadow:0 8px 15px rgba(102,126,234,.4)}
/* Card Styles */
.dashboard-card{background:white;border-radius:16px;border:1px solid var(--border-color);transition:all .3s ease}
.dashboard-card:hover{border-color:var(--primary-color);box-shadow:0 8px 25px rgba(102,126,234,.15)}
/* Login Styles */
.login-container{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
.login-card{background:white;border-radius:24px;padding:3rem;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);width:100%;max-width:420px}
.login-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 2rem}
/* User Role Badge */
.user-role-badge{background:linear-gradient(135deg,#10b981,#059669);color:white;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600}
.user-role-limited{background:linear-gradient(135deg,#06d2d9,#af06d9)}
/* Hide elements when not logged in */
.logged-in-only{display:none}
/* Table Styles for Song List */
.song-table{border-collapse:separate;border-spacing:0 10px}
.song-table thead th{border-bottom:2px solid var(--border-color);padding:1rem .75rem}
.song-table tbody tr{background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.05);transition:box-shadow .2s ease}
.song-table tbody tr:hover{box-shadow:0 4px 10px rgba(0,0,0,.1)}
.song-table tbody td{padding:1rem .75rem;vertical-align:middle}
/* -------------------- LOADING VIEW (SYNCHRONIZED) -------------------- */
#loadingCircle{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:white; 
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
    transition:opacity .5s ease;
}
#loadingCircle.hidden{opacity:0;pointer-events:none}

/* For 'Loading Songs from Sheet...' style */
.loading-text-container {
    display: flex;
    align-items: center;
    font-size: 1.5rem; /* Smaller font for better fit */
    font-weight: 600;
    color: #003366; /* Darker text color */
}

.loading-spinner {
    width: 24px; 
    height: 24px; 
    border: 3px solid rgba(0, 51, 102, 0.2); /* Dark blue border light opacity */
    border-top: 3px solid #003366; /* Dark blue for spinning part */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}
.loading-text-text {
    color: #003366; 
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* -------------------- OTHER STYLES -------------------- */
.topbar{display:flex;padding:12px;background:#fff;border-bottom:1px solid #ddd;gap:8px;justify-content:center}
.topbar input{flex:1 1 300px;padding:8px 12px;border:1px solid #ccc;border-radius:999px;font-size:14px}
.topbar button{padding:8px 16px;background:#003366;color:white;border:none;border-radius:999px;cursor:pointer}
/* UPDATED CATEGORIES STYLES */
.categories {
    display: flex;
    padding: 8px 5px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    overflow-x: hidden; /* By default hide scroll */
    white-space: nowrap;
    position: relative;
}
.categories-scroll-wrapper {
    display: flex;
    gap: 8px;
    overflow-x: auto; /* Enable scrolling only for categories */
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px; /* Space for a subtle scrollbar */
}
.categories-scroll-wrapper::-webkit-scrollbar {
    height: 4px;
}
.categories-scroll-wrapper::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 999px;
}
.categories button{padding:5px 8px;background:linear-gradient(135deg,#e0e0e0,#f9f9f9);border:1px solid #ccc;border-radius:999px;cursor:pointer;font-size:15px;font-weight:500;box-shadow:0 2px 4px rgba(0,0,0,.1);transition:all .2s ease;flex-shrink:0}
.categories button:hover{background:linear-gradient(135deg,#d0d0d0,#f0f0f0);transform:scale(1.03)}
/* ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø CSS ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
.categories button.active{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);color:#ffffff;box-shadow:0 4px 8px rgba(0,0,0,.2);border:1px solid var(--primary-color)}
/* Card View Styles (For Category Filtering) */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:16px}
.card{background:white;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.05);padding:12px;display:flex;flex-direction:column;align-items:center}
/* Updated for image placeholder support */
.card img{width:100%;height:180px;object-fit:cover;border-radius:6px;cursor:pointer;transition:transform .2s ease; background-color: #eee; border: 1px solid #ddd;} 
.card img:hover{transform:scale(1.03)}
.card img.playable{cursor:pointer}
.card h3{font-size:14px;margin:8px 0 4px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;width:100%}
.card .author{font-size:12px;color:#666;text-align:center}
.card .desc{font-size:12px;color:#555;margin-top:6px;text-align:center;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.actions{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.reaction{display:flex;flex-direction:column;align-items:center;justify-content:center;width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#e0f7ff,#d0eaff);box-shadow:0 2px 4px rgba(0,0,0,.12);font-size:16px;cursor:pointer;transition:transform .2s ease}
.reaction:hover{transform:scale(1.08)}
.reaction .emoji{font-size:16px}
.reaction .count{font-size:10px;font-weight:bold;color:#003366;margin-top:2px}
/* ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.fav-reaction .emoji{font-size:20px}
.fav-reaction[style*="color"] .emoji{filter:drop-shadow(0 0 1px #8A2BE2)}
/* -------------------- LIST VIEW STYLES -------------------- */
.song-list-container {
    display: flex;
    flex-direction: column;
    gap: 1px; /* Minimal gap */
    padding: 0;
    /* User requested not black, so we use a light background */
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,.05);
    margin: 16px; /* Match padding of original grid */
}
.song-list-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    background: white;
    transition: background .2s ease;
    cursor: pointer;
}
.song-list-item:hover {
    background: #f7f7f7;
}
.song-list-item:last-child {
    border-bottom: none;
}
.song-list-item .serial {
    font-weight: 600;
    color: #666;
    width: 30px;
    text-align: right;
    margin-right: 15px;
    font-size: 0.9rem;
    flex-shrink: 0;
}
.song-list-item .icon {
    font-size: 1.5rem;
    color: var(--primary-color);
    margin-right: 15px;
    width: 30px;
    text-align: center;
    flex-shrink: 0;
}
.song-list-item .title-info {
    flex-grow: 1;
    min-width: 0;
}
.song-list-item .title-info h4 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.song-list-item .title-info p {
    font-size: 0.85rem;
    color: #999;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.song-list-item .actions {
     margin-top: 0;
     gap: 8px;
     flex-shrink: 0;
}
/* Mobile adjustment for List View */
@media (max-width: 576px) {
    .song-list-container {
        margin: 8px;
    }
    .song-list-item {
        padding: 10px 12px;
    }
    .song-list-item .serial {
        width: 20px;
        margin-right: 8px;
    }
    .song-list-item .icon {
        font-size: 1.3rem;
        margin-right: 10px;
        width: 25px;
    }
    .song-list-item .title-info h4 {
        font-size: 0.9rem;
    }
    .song-list-item .title-info p {
        font-size: 0.75rem;
    }
    .song-list-item .actions {
         display: none; /* Hide reactions on very small screens for better space */
    }
}
/* -------------------- NEW PLAYER STYLES (UPDATED) -------------------- */
.full-player-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1f2937 0%,#000000 100%);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;color:white;padding:20px}
.player-header{position:absolute;top:20px;left:20px;width:calc(100% - 40px);display:flex;justify-content:flex-start}
.player-container{display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:450px;width:100%;padding:20px}
.album-art-box{width:100%;padding-bottom:90%;position:relative;margin-bottom:40px;max-width:400px;max-height:400px;}
.album-art{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);animation:pulse-art 6s infinite alternate; background-color: #333;} /* Added background for default art */
@keyframes pulse-art{0%{transform:scale(1)}100%{transform:scale(.5)}}
.player-info{text-align:center;margin-bottom:20px}

/* -------------------- NEW PLAYER STYLES (UPDATED WITH MARQUEE) -------------------- */
/* ... (Existing Player styles omitted for brevity) ... */

/* MARQUEE CONTAINER STYLES (For Player Title) */
.player-info h3 {
    /* ‡¶è‡¶ü‡¶ø‡¶á ‡¶ó‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú‡•§ 1.8rem ‡¶•‡ßá‡¶ï‡ßá 1.4rem ‡¶¨‡¶æ 1.5rem ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§ */
    font-size:1.5rem; 
    font-weight:700;
    margin-bottom:5px;
    color:var(--primary-color);
    text-shadow:0 0 5px rgba(17,237,230,.5);
    max-width: 100%; 
    overflow: hidden;
    white-space: nowrap;
    line-height: 1.2;
    padding: 0 10px; 
}

/* ... (Marquee @keyframes and other styles remain the same) ... */

/* Mobile Adjustments for Player */
@media (max-width:500px){
    /* ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá, ‡¶Ø‡ßá‡¶® ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶õ‡ßã‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º */
    .player-container{max-width:100%;padding:10px}
    .album-art-box{margin-bottom:20px}
    .player-info h4{font-size:1.2rem} /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá 1.2rem ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶≤‡¶æ‡¶Æ */
    .player-info p{font-size:.9rem}
    .control-btn.side i{font-size:1.8rem}
    .control-btn.main i{font-size:3rem}
}


/* NEW Custom Seek Bar Styles */
.custom-seek-bar-container {
    display: flex;
    align-items: center;
    width: 100%;
    margin-top: 30px;
    color: #fff;
    font-size: 0.9rem;
    gap: 10px;
    user-select: none; /* Prevents text selection during drag */
}

#customSeekBar {
    flex-grow: 1;
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: #444; /* Darker track */
    border-radius: 999px;
    cursor: pointer;
    margin: 0; /* Remove default margin */
}

/* Thumb (The circle that moves) */
#customSeekBar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #48b8e0; /* Blue color */
    cursor: pointer;
    box-shadow: 0 0 5px rgba(72, 184, 224, 0.5);
}
#customSeekBar::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #48b8e0;
    cursor: pointer;
    border: none;
}


/* UPDATED PLAYER CONTROLS STYLE */
.player-controls{display:flex;align-items:center;justify-content:center;width:100%;gap:25px; margin-top: 20px;}
.control-btn{background:none;border:none;color:white;cursor:pointer;transition:transform .2s ease,color .2s ease; padding: 10px;} /* Added padding for better hit area */
.control-btn:focus{outline:none;box-shadow:none}
.control-btn.side i{
    font-size:2.5rem; /* Slightly larger side buttons */
    color:#b0b0b0;
    transition: color 0.2s ease;
}
.control-btn.side:hover i {
    color: var(--primary-color); /* Hover color */
}
.control-btn.main i{
    font-size:5rem; /* Larger main button */
    color:var(--secondary-color);
    filter:drop-shadow(0 0 15px rgba(213,68,239,.8)); /* Stronger shadow */
}
.control-btn.main:hover i {
    transform: scale(1.05); /* Slight scale on main button hover */
}
.control-btn:hover{transform:scale(1.1)}
/* Mobile Adjustments for Player */
@media (max-width:500px){.player-container{max-width:100%;padding:10px}.album-art-box{margin-bottom:20px}.player-info h4{font-size:1.4rem}.player-info p{font-size:.9rem}.control-btn.side i{font-size:1.8rem}.control-btn.main i{font-size:3rem}}
/* --- MINI-PLAYER STYLE (UPDATED DESIGN) --- */
#miniPlayerBar{position:fixed;bottom:0;left:var(--sidebar-width);right:0;height:70px;background:#1a1a1a;color:white;z-index:1500;display:none;align-items:center;padding:0 15px;box-shadow:0 -5px 15px rgba(0,0,0,.4);transition:transform .3s ease, left .3s ease; cursor: pointer;}
#miniPlayerBar.show{display:flex}
@media (max-width:768px){#miniPlayerBar{left:0}}

.mini-player-art {
    width: 45px; 
    height: 45px; 
    border-radius: 5px; 
    object-fit: cover; 
    margin-right: 5px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    background: #333; /* Fallback for icon */
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 1.5rem;
}

.mini-player-info{
    flex-grow:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    padding-right:15px;
    cursor:pointer;
}
.mini-player-title{
    font-weight:700;
    font-size:0.95rem; /* Slightly smaller for 30 chars */
    color:var(--primary-color);
}
/* Mini player title only uses ellipsis for truncation, no marquee needed */
.mini-player-title .marquee-text {
    display: inline-block;
}

.mini-player-artist{
    font-size:.8rem;
    color:#bdc3c7;
}

/* NEW MINI-PLAYER CONTROLS */
.mini-player-controls{
    display: flex;
    align-items: center;
    gap: 15px;
}
.mini-control-btn{
    background:none;
    border:none;
    color:white;
    font-size: 1.6rem;
    cursor:pointer;
    transition: transform .1s ease;
    padding: 5px; /* Add padding for easier tap target */
}
.mini-control-btn:hover {
    transform: scale(1.1);
    color: var(--secondary-color);
}

.mini-control-btn.main i {
    font-size: 2.2rem;
    color: var(--primary-color);
}

.p-4 {
    
    border-bottom-width: 50px;
}
.fs-3 {
    font-size: calc(2.3rem + .6vw) !important;
}

</style>

</head>

<body>
<div id="loginScreen" class="login-container d-none"><div class="login-card"><div class="login-icon"><i class="fas fa-music text-white" style="font-size: 2rem;"></i></div><div class="text-center mb-4"><h1 class="h3 font-weight-bold text-gray-800 mb-2">ASV SONG MANAGER</h1><p class="text-muted">Manage your song inventory efficiently</p></div><form id="loginForm" class="space-y-4"><div class="mb-3"><label for="username" class="form-label font-weight-medium">Username</label><input type="text" id="username" class="form-control form-control-lg" required placeholder="Enter your username"></div><div class="mb-4"><label for="password" class="form-label font-weight-medium">Password</label><input type="password" id="password" class="form-control form-control-lg" required placeholder="Enter your password"></div><div class="mb-3"><div class="form-check"><input type="checkbox" id="rememberMe" class="form-check-input" checked><label for="rememberMe" class="form-check-label">Keep me logged in</label></div></div><button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-sign-in-alt me-2"></i>Sign In</button></form>
    <div class="text-center mt-3">
        <button class="btn btn-link text-danger font-weight-bold p-0" onclick="showDashboard(true)">Go to Dashboard</button>
    </div>
</div></div><div id="dashboard" class="d-none"><div class="mobile-header"><button class="btn btn-link p-0 text-dark" onclick="toggleSidebar()"><i class="fas fa-bars fs-5"></i></button><h5 class="mb-0 text-primary font-weight-bold fs-3 flex-grow-1 text-center"><i class="fas fa-music me-2"></i>MR SONGS</h5><button class="btn btn-outline-danger btn-sm logged-in-only" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button></div><div class="mobile-overlay" onclick="toggleSidebar()"></div><div class="sidebar" id="sidebar"><div class="sidebar-header"><div id="sidebarTitleContainer"><h5><i class="fas fa-music me-2"></i>ASV PROJECT</h5><div class="d-flex justify-content-between align-items-center mt-2 logged-in-only" id="loggedInBadgeContainer"><small class="text-light opacity-75">Song Management</small><span id="userRoleBadge" class="user-role-badge">Guest</span></div><div class="mt-2 text-white" id="guestUserText"><small class="opacity-75" style="display:none;">You are browsing as a **Guest**.</small></div></div></div><div class="sidebar-nav"><div class="nav-item"><a class="nav-link active" href="#" onclick="showSection('overview', this)"><i class="fas fa-tachometer-alt"></i>Dashboard</a></div><div class="nav-item"><a class="nav-link" href="#" onclick="showPlayerScreen(this)"><i class="fas fa-play-circle me-3"></i>Music Player</a></div><hr class="text-white mx-4 mt-4 logged-in-only"><div class="nav-item admin-only" id="addSongsNav"><a class="nav-link" href="#" onclick="showSection('add-song', this)"><i class="fas fa-plus-circle"></i>Add Song</a></div><div class="nav-item admin-only" id="listSongsNav"><a class="nav-link" href="#" onclick="showSection('list-songs', this)"><i class="fas fa-list-alt"></i>List Songs</a></div><div class="nav-item mt-2"><a class="nav-link bg-primary text-white" href="#" onclick="showLoginScreen(this)"><i class="fas fa-sign-in-alt"></i><span id="loginButtonText">Admin Login</span></a></div></div><div class="sidebar-footer"><div class="text-center mb-3 logged-in-only"><small class="text-muted">Logged in as: <span id="currentUsername" class="text-light">Guest</span></small></div><div class="text-center mt-3"><small class="text-muted">¬© 2025 ASV SONG MANAGER</small></div></div></div><div class="main-content"><div class="top-header logged-in-only" id="topHeader"><div class="d-flex justify-content-between align-items-center w-100"><div><h2 class="h4 mb-1 text-gray-800 font-weight-bold">Welcome back, <span id="topHeaderUsername">Guest</span>!</h2><p class="text-muted mb-0" id="currentDate"></p></div><div class="d-flex align-items-center logged-in-only"><div class="me-3"><small class="text-muted">Status: </small><span class="badge bg-success">Live</span></div><button class="btn btn-outline-primary me-2" onclick="refresh()"><i class="fas fa-sync-alt me-1"></i>Refresh</button><button class="btn btn-outline-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></div></div></div><div class="content-area"><div id="overview" class="section-content"><div class="mb-4"><h3 class="h5 font-weight-bold text-gray-800 mb-3">Song Management Overview</h3><div class="topbar"><input id="searchInput" type="text" placeholder="Search by title, author or category..." oninput="applyFilters()" /><button onclick="refresh()">Refresh</button></div>
<div class="categories">
    <button onclick="filterBy('all', this)">All Songs</button>
    <button onclick="filterBy('fav', this)">üíú Favorites</button>
    <div class="categories-scroll-wrapper" id="categoryList">
        </div>
</div>

<div id="loadingCircle"><div class="loading-text-container"><div class="loading-spinner"></div><span class="loading-text-text" id="overviewLoadingText">Loading Songs from Sheet...</span></div></div> 



<div id="bookGrid"></div> <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="position:fixed; bottom:80px; right:20px; background:#003366; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);">‚¨Ü</button></div></div><div id="add-song" class="section-content d-none"><div class="dashboard-card"><div class="p-4 border-bottom"><h5 class="mb-0 font-weight-bold"><i class="fas fa-plus-circle text-success me-2"></i>Add New Song</h5></div><div class="p-4"><form id="songForm"><div class="row g-4"><div class="col-md-6"><label for="serialNo" class="form-label font-weight-medium">Serial Number</label><input type="number" id="serialNo" class="form-control" required placeholder="e.g. 101"></div><div class="col-md-6"><label for="title" class="form-label font-weight-medium">Title</label><input type="text" id="title" class="form-control" required placeholder="Song Title"></div><div class="col-md-6"><label for="author" class="form-label font-weight-medium">Author/Artist</label><input type="text" id="author" class="form-control" required placeholder="Artist Name"></div><div class="col-md-6"><label for="category" class="form-label font-weight-medium">Category</label><input type="text" id="category" class="form-control" required placeholder="e.g. Pop, Folk"></div><div class="col-md-6"><label for="imageUrl" class="form-label font-weight-medium">Image_URL</label><input type="url" id="imageUrl" class="form-control" placeholder="Optional image link"></div><div class="col-md-6"><label for="songUrl" class="form-label font-weight-medium">Song_URL</label><input type="url" id="songUrl" class="form-control" required placeholder="Direct song link"></div><div class="col-12"><label for="description" class="form-label font-weight-medium">Description</label><textarea id="description" class="form-control" rows="3" placeholder="Optional description of the song"></textarea></div></div><div class="mt-4"><button type="submit" class="btn btn-primary me-2"><i class="fas fa-plus me-2"></i>Add Song</button><button type="reset" class="btn btn-outline-secondary"><i class="fas fa-undo me-2"></i>Reset</button></div></form></div></div></div><div id="list-songs" class="section-content d-none"><div class="dashboard-card"><div class="p-4 border-bottom d-flex justify-content-between align-items-center"><h5 class="mb-0 font-weight-bold"><i class="fas fa-list-alt text-danger me-2"></i>All Songs List</h5><button class="btn btn-outline-primary btn-sm" onclick="fetchSongs()"><i class="fas fa-sync-alt me-1"></i>Refresh List</button></div><div class="p-4 border-bottom"><div class="input-group"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="text" id="songSearchInput" class="form-control" placeholder="Search by Title, Author, or Category..." onkeyup="filterSongs()"></div></div><div class="p-4 table-responsive"><table class="table table-hover song-table"><thead><tr><th>#</th><th>Date</th><th>Title</th><th>Author</th><th>Category</th><th class="text-center">Actions</th></tr></thead><tbody id="songsTableBody"><tr><td colspan="6" class="text-center text-muted">Click 'Refresh List' or switch section to load songs.</td></tr></tbody></table></div></div></div></div></div><div class="full-player-screen" id="fullPlayerScreen"><div class="player-header"><button class="btn btn-light" onclick="closePlayer()"><i class="fas fa-arrow-left me-2"></i>Back To Dashboard</button></div><div class="player-container"><div class="album-art-box"><img id="playerArt" src="https://via.placeholder.com/400?text=Select+Song" alt="Album Art" class="album-art"></div><div class="player-info">
    <h4 id="playerTitle">
        <span id="playerTitleText">‡¶ó‡¶æ‡¶® ‡¶ö‡¶≤‡¶õ‡ßá ‡¶®‡¶æ</span>
    </h4>
    <p id="playerArtist">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
</div>

<div class="custom-seek-bar-container">
    <span id="currentTimeDisplay">0:00</span>
    <input type="range" id="customSeekBar" value="0" step="1" min="0" max="100">
    <span id="durationDisplay">0:00</span>
</div>
<div class="player-controls">
    <button class="control-btn side" onclick="playPrev()" title="Previous Song"><i class="fas fa-step-backward"></i></button>
    <button class="control-btn main" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause"><i class="fas fa-play-circle"></i></button>
    <button class="control-btn side" onclick="playNext()" title="Next Song"><i class="fas fa-step-forward"></i></button>
</div>
<audio id="audioElement" controlsList="nodownload" class="d-none"></audio>
</div></div>

<div id="miniPlayerBar" onclick="showPlayerScreen(document.querySelector('.nav-item a[onclick*=\'showPlayerScreen\']'))">
    <div id="miniPlayerArt" class="mini-player-art">
         <i class="fas fa-music"></i>
    </div>
    <div class="mini-player-info">
        <div id="miniPlayerTitle" class="mini-player-title">‡¶ó‡¶æ‡¶® ‡¶ö‡¶≤‡¶õ‡ßá ‡¶®‡¶æ</div>
        <div id="miniPlayerArtist" class="mini-player-artist">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</div>
    </div>
    <div class="mini-player-controls">
        <button class="mini-control-btn" onclick="event.stopPropagation(); playPrev();"><i class="fas fa-backward-step"></i></button>
        <button class="mini-control-btn main" id="miniPlayPauseBtn" onclick="event.stopPropagation(); togglePlayPause();"><i class="fas fa-play"></i></button>
        <button class="mini-control-btn" onclick="event.stopPropagation(); playNext();"><i class="fas fa-forward-step"></i></button>
    </div>
</div>
<div class="modal fade" id="editSongModal" tabindex="-1" aria-labelledby="editSongModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="editSongModalLabel"><i class="fas fa-edit me-2 text-info"></i>Edit Song Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><form id="editSongForm"><div class="modal-body"><input type="hidden" id="editRowId"><div class="row g-3"><div class="col-md-6"><label for="editSerialNo" class="form-label font-weight-medium">Serial Number</label><input type="number" id="editSerialNo" class="form-control" required></div><div class="col-md-6"><label for="editTitle" class="form-label font-weight-medium">Title</label><input type="text" id="editTitle" class="form-control" required></div><div class="col-md-6"><label for="editAuthor" class="form-label font-weight-medium">Author/Artist</label><input type="text" id="editAuthor" class="form-control" required></div><div class="col-md-6"><label for="editCategory" class="form-label font-weight-medium">Category</label><input type="text" id="editCategory" class="form-control" required></div><div class="col-md-6"><label for="editImageUrl" class="form-label font-weight-medium">Image_URL</label><input type="url" id="editImageUrl" class="form-control"></div><div class="col-md-6"><label for="editSongUrl" class="form-label font-weight-medium">Song_URL</label><input type="url" id="editSongUrl" class="form-control" required></div><div class="col-12"><label for="editDescription" class="form-label font-weight-medium">Description</label><textarea id="editDescription" class="form-control" rows="3"></textarea></div><div class="col-12"><small class="text-muted">Date Added: <span id="editDateAdded"></span></small></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div></form></div></div></div>

  <script>
    /* 
    ============================================================
    üöÄ GITHUB COMPATIBLE SCRIPT FOR ASV SONG MANAGER
    ============================================================
    */

    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶§‡ßç‡¶§ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶ü‡ßã‡¶ï‡ßá‡¶®
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGYi8h5VBxy41qxJDcPNBqERci5dm8haHlwYwISt_ewPXK0QdUIAj7notIXwjsyPJwXg/exec";
    const SECRET_TOKEN = "ASV_SONG_MANAGER_PRO_2024"; 

    // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßá‡¶á‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Fetch API)
    async function runGAS(action, payload = {}) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    token: SECRET_TOKEN, 
                    action: action, 
                    payload: payload 
                })
            });
            const result = await response.json();
            return result;
        } catch (err) {
            console.error("Connection Error:", err);
            return { success: false, message: "Network connection error!" };
        }
    }

    // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π ---
    let currentUser = 'Guest';
    let currentUserRole = 'GUEST';
    let isAdmin = false;
    let isUserLoggedIn = false;
    const AUTH_STORAGE_KEY = 'asv_auth_data_songs';
    const LOGIN_EXPIRY_DAYS = 30;
    let allBooks = []; 
    let currentFilter = 'all';
    let currentCategory = '';
    let allSongs = []; 
    
    // ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤
    const audio = document.getElementById('audioElement');
    const fullPlayerScreen = document.getElementById('fullPlayerScreen');
    const playerTitle = document.getElementById('playerTitle');
    const playerTitleText = document.getElementById('playerTitleText'); 
    const playerArtist = document.getElementById('playerArtist');
    const playerArt = document.getElementById('playerArt');
    const playPauseBtn = document.getElementById('playPauseBtn');
    let currentSongIndex = -1; 
    let currentPlaylist = []; 
    const DEFAULT_COVER_URL = 'https://res.cloudinary.com/dukooy5f1/image/upload/v1676877360/IMG_20230209_060336_335_zdwejn.jpg'; 

    // ‡¶Æ‡¶ø‡¶®‡¶ø ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶∞
    const miniPlayerBar = document.getElementById('miniPlayerBar');
    const miniPlayerTitle = document.getElementById('miniPlayerTitle');
    const miniPlayerArtist = document.getElementById('miniPlayerArtist');
    const miniPlayerArtDiv = document.getElementById('miniPlayerArt');
    const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
    const customSeekBar = document.getElementById('customSeekBar');
    const currentTimeDisplay = document.getElementById('currentTimeDisplay');
    const durationDisplay = document.getElementById('durationDisplay');
    let isSeeking = false;

    // DOM Elements
    const loadingCircle = document.getElementById('loadingCircle');
    const categoryList = document.getElementById('categoryList');
    const bookGrid = document.getElementById('bookGrid');
    const searchInput = document.getElementById('searchInput');

    // --- ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentDate();
        setInterval(updateCurrentDate, 60000);
        checkSavedLogin();
        showDashboard(false);
        showAndHideCircle(true);
        
        // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        document.getElementById('songForm')?.addEventListener('submit', handleSongFormSubmit);
        document.getElementById('editSongForm')?.addEventListener('submit', handleEditFormSubmit);
        
        // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π
        audio.addEventListener('play', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause-circle"></i>';
            updateMiniPlayerUI(true);
        });
        audio.addEventListener('pause', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play-circle"></i>';
            updateMiniPlayerUI(false);
        });
        audio.addEventListener('ended', () => playNext());
        
        // ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        audio.addEventListener('loadedmetadata', () => {
            customSeekBar.max = audio.duration;
            durationDisplay.textContent = formatTime(audio.duration);
        });
        audio.addEventListener('timeupdate', () => {
            if (!isSeeking && !isNaN(audio.duration)) { 
                customSeekBar.value = audio.currentTime;
                updateSeekBarUI(audio.currentTime, audio.duration);
            }
            currentTimeDisplay.textContent = formatTime(audio.currentTime);
            savePlaybackPosition();
        });

        customSeekBar.addEventListener('input', () => {
            isSeeking = true;
            currentTimeDisplay.textContent = formatTime(customSeekBar.value);
            updateSeekBarUI(customSeekBar.value, customSeekBar.max);
        });
        customSeekBar.addEventListener('change', () => {
            isSeeking = false;
            audio.currentTime = customSeekBar.value;
        });

        addSwipeGestureToPlayer();
        refresh(); // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ
    });

    // --- ‡¶Æ‡ßÇ‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π (GitHub-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ) ---

    async function refresh() {
        showAndHideCircle(true, "Synchronizing Database...");
        const data = await runGAS('getBooks');
        allBooks = data || [];
        currentPlaylist = allBooks.filter(book => book.Song_URL && book.Song_URL.startsWith('http'));
        renderCategories();
        filterBy('all', document.querySelector('.categories button'));
        restorePlaybackState();
        showAndHideCircle(false);
    }

    async function handleLoginSubmit(e) {
        e.preventDefault();
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        
        Swal.fire({title: 'Authenticating...', didOpen: () => Swal.showLoading()});
        const result = await runGAS('authenticateUser', {username: user, password: pass});
        Swal.close();

        if (result.success) {
            applyLoginData(result);
            saveLoginData(result);
            Swal.fire('Welcome!', 'Login Successful', 'success');
            showDashboard();
            refresh();
        } else {
            Swal.fire('Error', result.message, 'error');
        }
    }
    document.getElementById('loginForm').onsubmit = handleLoginSubmit;

    async function handleReaction(type, rowId) {
        if (rowId >= 10000) { Swal.fire('Note', 'Reactions not available for Drive songs.', 'info'); return; }
        if (!isUserLoggedIn) { Swal.fire('Login Required', '', 'warning'); return; }
        
        const result = await runGAS('updateFeedback', {rowId, type});
        if(result.success) refresh();
    }

    async function handleSongFormSubmit(e) {
        e.preventDefault();
        const songData = {
            serialNo: document.getElementById('serialNo').value,
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            category: document.getElementById('category').value,
            imageUrl: document.getElementById('imageUrl').value,
            songUrl: document.getElementById('songUrl').value,
            description: document.getElementById('description').value
        };
        Swal.fire({title: 'Adding Song...', didOpen: () => Swal.showLoading()});
        const res = await runGAS('addSong', {songData});
        Swal.fire('Success', res.message, 'success');
        document.getElementById('songForm').reset();
        refresh();
    }

    async function fetchSongs() {
        const tableBody = document.getElementById('songsTableBody');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading List...</td></tr>`;
        const result = await runGAS('getSongsList');
        if(result.success) {
            allSongs = result.songs;
            displaySongs(allSongs);
        }
    }

    async function editSong(rowId) {
        Swal.showLoading();
        const result = await runGAS('getSongById', {rowId});
        Swal.close();
        if(result.success) loadEditForm(result);
    }

    async function deleteSong(rowId) {
        const confirm = await Swal.fire({title: 'Delete?', text: "This cannot be undone!", icon: 'warning', showCancelButton: true});
        if(confirm.isConfirmed) {
            Swal.showLoading();
            const result = await runGAS('deleteSong', {rowId, username: currentUser});
            if(result.success) { Swal.fire('Deleted!', '', 'success'); fetchSongs(); refresh(); }
        }
    }

    // --- ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π ---

    function loadAndPlaySong(index) {
        if (index >= 0 && index < currentPlaylist.length) {
            currentSongIndex = index;
            const song = currentPlaylist[index];
            updateFullPlayerUI(song);
            audio.src = song.Song_URL;
            audio.load();
            audio.play().catch(e => console.log("Autoplay blocked. User interaction required."));
            fullPlayerScreen.style.display = 'flex';
            updateMiniPlayerUI(true);
        }
    }

    function togglePlayPause() {
        if (audio.paused) audio.play(); else audio.pause();
    }

    function playNext() {
        loadAndPlaySong((currentSongIndex + 1) % currentPlaylist.length);
    }

    function playPrev() {
        loadAndPlaySong((currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length);
    }

    function updateFullPlayerUI(song) {
        playerTitleText.textContent = song.Title || 'Untitled';
        playerArtist.textContent = song.Author || 'Unknown Artist';
        playerArt.src = (song.Image_URL && song.Image_URL.startsWith('http')) ? song.Image_URL : DEFAULT_COVER_URL;
        playerTitle.classList.toggle('marquee-active', (song.Title || '').length > 40);
        
        currentTimeDisplay.textContent = '0:00';
        durationDisplay.textContent = '0:00';
        customSeekBar.value = 0;
        updateSeekBarUI(0, 100);
    }

    function updateMiniPlayerUI(isPlaying) {
        if (currentSongIndex !== -1 && currentPlaylist[currentSongIndex]) {
            const song = currentPlaylist[currentSongIndex];
            const titleText = song.Title || 'Untitled';
            miniPlayerTitle.textContent = titleText.length > 30 ? titleText.substring(0, 27) + '...' : titleText;
            miniPlayerArtist.textContent = song.Author;
            miniPlayPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            miniPlayerBar.classList.add('show');
        }
    }

    // --- ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π ---

    function formatTime(s) {
        const m = Math.floor(s/60); const sc = Math.floor(s%60);
        return `${m}:${sc < 10 ? '0' : ''}${sc}`;
    }

    function updateSeekBarUI(c, d) {
        const p = (c / d) * 100;
        customSeekBar.style.background = `linear-gradient(to right, #48b8e0 0%, #48b8e0 ${p}%, #444 ${p}%, #444 100%)`;
    }

    function showAndHideCircle(s, t) {
        if(s) { loadingCircle.classList.remove('hidden'); if(t) document.getElementById('overviewLoadingText').textContent = t; }
        else { loadingCircle.classList.add('hidden'); }
    }

    function checkSavedLogin() {
        const saved = localStorage.getItem(AUTH_STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            if (new Date() < new Date(data.expiry)) { applyLoginData(data); return; }
        }
        applyGuestData();
    }

    function applyLoginData(data) {
        currentUser = data.username; currentUserRole = data.role;
        isAdmin = (data.role === 'ALL'); isUserLoggedIn = true;
        document.getElementById('currentUsername').textContent = currentUser;
        document.getElementById('topHeaderUsername').textContent = currentUser;
        updateUIForUserRole();
    }

    function applyGuestData() {
        currentUser = 'Guest'; currentUserRole = 'GUEST';
        isAdmin = false; isUserLoggedIn = false;
        updateUIForUserRole();
    }

    function updateUIForUserRole() {
        document.querySelectorAll('.logged-in-only').forEach(el => el.style.display = isUserLoggedIn ? '' : 'none');
        document.getElementById('adminPanel')?.classList.toggle('d-none', !isAdmin);
        document.getElementById('loginButtonText').textContent = isUserLoggedIn ? 'Logout' : 'Admin Login';
    }

    function logout() {
        localStorage.removeItem(AUTH_STORAGE_KEY);
        location.reload();
    }

    // (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶¨ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: showSection, toggleSidebar, renderCategories, displaySongs, updateCurrentDate ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
    function updateCurrentDate() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        if(document.getElementById('currentDate')) document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
    }

    function showDashboard(force) {
        document.getElementById('loginScreen').classList.add('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        updateUIForUserRole();
        if(force) showSection('overview', document.querySelector('.nav-link'));
    }

    function showSection(name, el) {
        document.querySelectorAll('.section-content').forEach(s => s.classList.add('d-none'));
        document.getElementById(name).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(el) el.classList.add('active');
        if(window.innerWidth < 768) toggleSidebar();
        if(name === 'list-songs') fetchSongs();
        fullPlayerScreen.style.display = 'none';
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.querySelector('.mobile-overlay').classList.toggle('show');
    }

    function renderCategories() {
        const categories = {};
        allBooks.forEach(b => { if(b.Category) categories[b.Category] = (categories[b.Category] || 0) + 1; });
        categoryList.innerHTML = '';
        Object.keys(categories).sort().forEach(cat => {
            const btn = document.createElement('button');
            btn.textContent = `${cat} (${categories[cat]})`;
            btn.onclick = () => { currentFilter = 'category'; currentCategory = cat; applyFilters(); };
            categoryList.appendChild(btn);
        });
    }

    function filterBy(type, el) {
        currentFilter = type; currentCategory = '';
        document.querySelectorAll('.categories button').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const term = searchInput.value.toLowerCase();
        let filtered = allBooks.filter(b => {
            const match = `${b.Title} ${b.Author} ${b.Category}`.toLowerCase().includes(term);
            if(currentFilter === 'fav') return match && b.Favorite === 'Y';
            if(currentFilter === 'category') return match && b.Category === currentCategory;
            return match;
        });
        
        currentPlaylist = filtered.filter(b => b.Song_URL && b.Song_URL.startsWith('http'));
        bookGrid.innerHTML = filtered.map((b, idx) => `
            <div class="card">
                <img src="${b.Image_URL || DEFAULT_COVER_URL}" onclick="loadAndPlaySong(${currentPlaylist.indexOf(b)})">
                <h3>${b.Title}</h3>
                <p>${b.Author}</p>
                <div class="actions">
                    <div class="reaction" onclick="handleReaction('fav', ${b.rowId})">
                        <span class="emoji">${b.Favorite === 'Y' ? 'üíú' : 'ü§ç'}</span>
                    </div>
                </div>
            </div>
        `).join('') || '<p class="text-center w-100 p-5">No songs found.</p>';
    }

    function closePlayer() {
        fullPlayerScreen.style.display = 'none';
        updateMiniPlayerUI(!audio.paused);
    }

    function showPlayerScreen() {
        fullPlayerScreen.style.display = 'flex';
        if(currentSongIndex === -1 && currentPlaylist.length > 0) loadAndPlaySong(0);
    }

    function addSwipeGestureToPlayer() {
        let startX;
        fullPlayerScreen.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        fullPlayerScreen.addEventListener('touchend', e => {
            const diffX = e.changedTouches[0].clientX - startX;
            if(Math.abs(diffX) > 50) diffX > 0 ? playPrev() : playNext();
        });
    }

    // ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶≠ ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
    function savePlaybackPosition() {
        if (!audio.paused && currentSongIndex !== -1) {
            localStorage.setItem('lastIdx', currentSongIndex);
            localStorage.setItem('lastPos', audio.currentTime);
        }
    }
    function restorePlaybackState() {
        const idx = localStorage.getItem('lastIdx');
        const pos = localStorage.getItem('lastPos');
        if(idx !== null && currentPlaylist[idx]) {
            currentSongIndex = parseInt(idx);
            const song = currentPlaylist[currentSongIndex];
            updateFullPlayerUI(song);
            audio.src = song.Song_URL;
            audio.currentTime = parseFloat(pos || 0);
            updateMiniPlayerUI(false);
        }
    }

    function saveLoginData(data) {
        const expiry = new Date(); expiry.setDate(expiry.getDate() + LOGIN_EXPIRY_DAYS);
        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({...data, expiry: expiry.toISOString()}));
    }
</script>
</body>

</html>
